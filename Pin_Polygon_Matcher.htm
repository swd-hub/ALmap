<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoJSON ç›¸äº’å¯¾å¿œãƒ‡ãƒ¼ã‚¿æŠ½å‡ºãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            margin: 20px;
            background-color: #f0f2f5;
            color: #333;
        }
        h1 {
            color: #17a2b8;
            text-align: center;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .input-section {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
        }
        .input-group {
            flex: 1;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        h2 {
            font-size: 1.2em;
            color: #17a2b8;
            margin-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 5px;
        }
        label {
            display: block;
            margin-top: 10px;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="file"], input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: block;
            width: 100%;
            margin-top: 20px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .output-section {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }
        .output-box {
            flex: 1;
        }
        textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            background-color: #f9f9f9;
            box-sizing: border-box;
            margin-bottom: 10px;
        }
        .message {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>GeoJSON ç›¸äº’å¯¾å¿œãƒ‡ãƒ¼ã‚¿æŠ½å‡ºãƒ„ãƒ¼ãƒ«</h1>
        <p>ãƒ”ãƒ³ãƒ‡ãƒ¼ã‚¿ã¨ãƒãƒªã‚´ãƒ³ãƒ‡ãƒ¼ã‚¿ã®å±æ€§ã‚’ç…§åˆã—ã€**å…±é€šã®ã‚­ãƒ¼ã‚’æŒã¤**ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã ã‘ã‚’æŠ½å‡ºã—ã¦å‡ºåŠ›ã—ã¾ã™ã€‚</p>

        <div class="input-section">
            
            <div class="input-group" style="background-color: #f8f9fa;">
                <h2>ğŸ“ ãƒ”ãƒ³ (Point) ãƒ‡ãƒ¼ã‚¿</h2>
                <label for="pinFile">GeoJSONãƒ•ã‚¡ã‚¤ãƒ« (.geojson, .json):</label>
                <input type="file" id="pinFile" accept=".json,.geojson">
                <label for="pinKey">ç…§åˆã‚­ãƒ¼å (ä¾‹: city_code):</label>
                <input type="text" id="pinKey" placeholder="å±æ€§ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" value="id">
            </div>

            <div class="input-group" style="background-color: #f8f9fa;">
                <h2>ğŸ—ºï¸ ãƒãƒªã‚´ãƒ³ (Polygon) ãƒ‡ãƒ¼ã‚¿</h2>
                <label for="polyFile">GeoJSONãƒ•ã‚¡ã‚¤ãƒ« (.geojson, .json):</label>
                <input type="file" id="polyFile" accept=".json,.geojson">
                <label for="polyKey">ç…§åˆã‚­ãƒ¼å (ä¾‹: code):</label>
                <input type="text" id="polyKey" placeholder="å±æ€§ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" value="id">
            </div>
            
        </div>
        
        <button onclick="matchFeatures()" id="processBtn">ç…§åˆã—ã¦å¯¾å¿œãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›</button>
        <div id="statusMessage" class="message"></div>
        
        <div class="output-section">
            <div class="output-box">
                <h2>å‡ºåŠ› 1: å¯¾å¿œã—ãŸãƒ”ãƒ³ GeoJSON</h2>
                <textarea id="matchedPinsOutput" readonly placeholder="çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™..."></textarea>
                <button onclick="downloadResult('pins')" id="downloadPinsBtn" style="display:none; background-color: #28a745;">ãƒ”ãƒ³ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
            <div class="output-box">
                <h2>å‡ºåŠ› 2: å¯¾å¿œã—ãŸãƒãƒªã‚´ãƒ³ GeoJSON</h2>
                <textarea id="matchedPolygonsOutput" readonly placeholder="çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™..."></textarea>
                <button onclick="downloadResult('polygons')" id="downloadPolygonsBtn" style="display:none; background-color: #28a745;">ãƒãƒªã‚´ãƒ³ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
        </div>
    </div>

    <script>
        let matchedPinsString = "";
        let matchedPolygonsString = "";

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’éåŒæœŸã§èª­ã¿è¾¼ã‚€æ±ç”¨é–¢æ•°
        function readFileAsync(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        resolve(JSON.parse(e.target.result));
                    } catch (err) {
                        reject(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã¯æœ‰åŠ¹ãªGeoJSONã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
                    }
                };
                reader.onerror = () => reject(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
                reader.readAsText(file);
            });
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºé–¢æ•°
        function showMsg(text, isError = false) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = text;
            statusDiv.className = isError ? "message error" : "message success";
            statusDiv.style.display = "block";
        }

        async function matchFeatures() {
            const pinFileInput = document.getElementById('pinFile');
            const polyFileInput = document.getElementById('polyFile');
            const pinKeyName = document.getElementById('pinKey').value.trim();
            const polyKeyName = document.getElementById('polyKey').value.trim();
            const processBtn = document.getElementById('processBtn');

            document.getElementById('matchedPinsOutput').value = '';
            document.getElementById('matchedPolygonsOutput').value = '';
            document.getElementById('downloadPinsBtn').style.display = 'none';
            document.getElementById('downloadPolygonsBtn').style.display = 'none';
            document.getElementById('statusMessage').style.display = 'none';

            if (!pinKeyName || !polyKeyName) {
                showMsg('ç…§åˆã‚­ãƒ¼åã‚’ä¸¡æ–¹å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', true);
                return;
            }

            if (pinFileInput.files.length === 0 || polyFileInput.files.length === 0) {
                showMsg('ãƒ”ãƒ³GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒãƒªã‚´ãƒ³GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸¡æ–¹ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', true);
                return;
            }

            processBtn.disabled = true;
            processBtn.textContent = "ç…§åˆä¸­...";

            try {
                // 1. ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã¨ãƒ‘ãƒ¼ã‚¹
                const pinData = await readFileAsync(pinFileInput.files[0]);
                const polyData = await readFileAsync(polyFileInput.files[0]);

                const pinFeatures = pinData.features || (pinData.type === 'Feature' ? [pinData] : []);
                const polyFeatures = polyData.features || (polyData.type === 'Feature' ? [polyData] : []);

                if (pinFeatures.length === 0 || polyFeatures.length === 0) {
                    throw new Error("GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ï¼ˆFeatureï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                }
                
                // 2. åŒæ–¹ã®ã‚­ãƒ¼å€¤ã‚»ãƒƒãƒˆã‚’ä½œæˆ
                const pinKeyValues = new Set();
                const polyKeyValues = new Set();
                
                pinFeatures.forEach(f => {
                    const value = f.properties ? f.properties[pinKeyName] : undefined;
                    if (value !== undefined) pinKeyValues.add(String(value));
                });
                
                polyFeatures.forEach(f => {
                    const value = f.properties ? f.properties[polyKeyName] : undefined;
                    if (value !== undefined) polyKeyValues.add(String(value));
                });

                // 3. å…±é€šã‚­ãƒ¼ï¼ˆIntersectionï¼‰ã®æŠ½å‡º
                const matchingKeys = new Set();
                polyKeyValues.forEach(value => {
                    if (pinKeyValues.has(value)) {
                        matchingKeys.add(value);
                    }
                });

                if (matchingKeys.size === 0) {
                    showMsg('ä¸€è‡´ã™ã‚‹ã‚­ãƒ¼å€¤ãŒä¸€ã¤ã‚‚è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã‚­ãƒ¼åã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', true);
                    return;
                }

                // 4. ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const matchedPins = pinFeatures.filter(f => {
                    const value = f.properties ? f.properties[pinKeyName] : undefined;
                    return value !== undefined && matchingKeys.has(String(value));
                });
                
                const matchedPolygons = polyFeatures.filter(f => {
                    const value = f.properties ? f.properties[polyKeyName] : undefined;
                    return value !== undefined && matchingKeys.has(String(value));
                });

                // 5. çµæœã®GeoJSONæ§‹ç¯‰ã¨è¡¨ç¤º
                const resultPins = { type: "FeatureCollection", features: matchedPins };
                const resultPolygons = { type: "FeatureCollection", features: matchedPolygons };

                matchedPinsString = JSON.stringify(resultPins, null, 2);
                matchedPolygonsString = JSON.stringify(resultPolygons, null, 2);
                
                document.getElementById('matchedPinsOutput').value = matchedPinsString;
                document.getElementById('matchedPolygonsOutput').value = matchedPolygonsString;
                
                document.getElementById('downloadPinsBtn').style.display = 'block';
                document.getElementById('downloadPolygonsBtn').style.display = 'block';

                showMsg(
                    `å‡¦ç†å®Œäº†ï¼\n` +
                    `ä¸€è‡´ã—ãŸå…±é€šã‚­ãƒ¼æ•°: ${matchingKeys.size}ä»¶\n` +
                    `æŠ½å‡ºã•ã‚ŒãŸãƒ”ãƒ³æ•°: ${matchedPins.length}ä»¶ / æŠ½å‡ºã•ã‚ŒãŸãƒãƒªã‚´ãƒ³æ•°: ${matchedPolygons.length}ä»¶`
                );

            } catch (error) {
                showMsg('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error, true);
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = "ç…§åˆã—ã¦å¯¾å¿œãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›";
            }
        }

        function downloadResult(type) {
            let jsonString, fileName;
            
            if (type === 'pins') {
                jsonString = matchedPinsString;
                fileName = "matched_pins.geojson";
            } else if (type === 'polygons') {
                jsonString = matchedPolygonsString;
                fileName = "matched_polygons.geojson";
            } else {
                return;
            }

            const blob = new Blob([jsonString], { type: "application/geo+json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
