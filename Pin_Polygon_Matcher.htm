<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoJSON ç©ºé–“æŠ½å‡º (ãƒãƒªã‚´ãƒ³ï¼†ãƒ”ãƒ³å‡ºåŠ›ç‰ˆ)</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; margin: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #d63384; text-align: center; border-bottom: 2px solid #d63384; padding-bottom: 10px; }
        
        .input-group { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #fafafa; }
        label { font-weight: bold; display: block; margin-bottom: 5px; }
        
        /* ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .file-list-area { margin-bottom: 20px; padding: 10px; border: 1px dashed #aaa; background: #fff; border-radius: 5px; min-height: 50px; }
        .file-list-header { font-size: 0.9em; color: #666; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
        ul { list-style: none; padding: 0; margin: 0; }
        li { padding: 5px 10px; border-bottom: 1px solid #eee; font-size: 0.9em; display: flex; justify-content: space-between; }
        li:last-child { border-bottom: none; }
        .type-badge { font-size: 0.8em; padding: 2px 6px; border-radius: 4px; margin-left: 10px; }
        .badge-pin { background: #e0f7fa; color: #006064; }
        .badge-poly { background: #fff3e0; color: #e65100; }

        .settings-area { background-color: #fff3cd; border: 1px solid #ffeeba; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .checkbox-label { display: flex; align-items: center; cursor: pointer; font-weight: bold; color: #856404; }
        input[type="checkbox"] { transform: scale(1.5); margin-right: 10px; }

        .btn-group { display: flex; gap: 10px; margin-bottom: 15px; }
        button { flex: 1; padding: 15px; border: none; border-radius: 5px; font-size: 1.1em; cursor: pointer; font-weight: bold; transition: background 0.2s; }
        #runBtn { background: #007bff; color: white; flex: 2; }
        #runBtn:hover { background: #0056b3; }
        #runBtn:disabled { background: #ccc; cursor: not-allowed; }
        
        #clearBtn { background: #dc3545; color: white; flex: 1; }
        #clearBtn:hover { background: #a71d2a; }

        /* ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
        .download-area { display: none; gap: 10px; margin-top: 15px; }
        .dl-btn { color: white; display: flex; align-items: center; justify-content: center; flex-direction: column; font-size: 0.95em; }
        #dlPolyBtn { background: #fd7e14; } /* ã‚ªãƒ¬ãƒ³ã‚¸ */
        #dlPolyBtn:hover { background: #e36b0a; }
        #dlPinBtn { background: #20c997; } /* ã‚°ãƒªãƒ¼ãƒ³ */
        #dlPinBtn:hover { background: #1aa179; }
        .dl-badge { font-size: 0.8em; opacity: 0.9; font-weight: normal; margin-top: 2px; }

        textarea { width: 100%; height: 150px; font-family: monospace; border: 1px solid #ccc; padding: 10px; margin-top: 10px; font-size: 0.85em; background: #fdfdfd; }
        .status { margin-top: 15px; padding: 10px; border-radius: 5px; display: none; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“ ãƒ”ãƒ³ãƒ»ãƒãƒªã‚´ãƒ³ ç›¸äº’æŠ½å‡ºãƒ„ãƒ¼ãƒ«</h1>
    <p>GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€ã€Œãƒ”ãƒ³ãŒå«ã¾ã‚Œã‚‹ãƒãƒªã‚´ãƒ³ã€ã¨ã€Œãƒãƒªã‚´ãƒ³å†…ã®ãƒ”ãƒ³ã€ã‚’æŠ½å‡ºã—ã¾ã™ã€‚<br>
    ï¼ˆè¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼‰</p>

    <div class="input-group">
        <label>ğŸ“ GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ </label>
        <input type="file" id="fileInput" accept=".json,.geojson" multiple onchange="handleFiles(this.files)">
    </div>

    <div class="file-list-area">
        <div class="file-list-header">
            <span>ç¾åœ¨ã®èª­ã¿è¾¼ã¿ãƒªã‚¹ãƒˆ:</span>
            <span id="countDisplay">0 ãƒ•ã‚¡ã‚¤ãƒ« (ãƒ”ãƒ³: 0 / ãƒãƒªã‚´ãƒ³: 0)</span>
        </div>
        <ul id="fileList">
            <li style="color:#999; text-align:center;">ã¾ã ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</li>
        </ul>
    </div>

    <div class="settings-area">
        <label class="checkbox-label">
            <input type="checkbox" id="strictMode">
            å³å¯†ãªå½¢çŠ¶åˆ¤å®šã‚’è¡Œã† (OFFæ¨å¥¨)
        </label>
        <p style="margin: 5px 0 0 30px; font-size: 0.9em; color: #666;">
            OFF (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ): å››è§’ã„ç¯„å›²(BBox)ã§åˆ¤å®šã€‚é«˜é€Ÿã€‚<br>
            ON: ãƒãƒªã‚´ãƒ³ã®è©³ç´°ãªå½¢çŠ¶ã§åˆ¤å®šã€‚ãƒ‡ãƒ¼ã‚¿é‡ãŒå¤šã„ã¨å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚
        </p>
    </div>

    <div class="btn-group">
        <button id="clearBtn" onclick="clearAllData()">ğŸ—‘ï¸ ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢</button>
        <button id="runBtn" onclick="runProcess()">â–¶ï¸ å‡¦ç†å®Ÿè¡Œ</button>
    </div>

    <div id="status" class="status"></div>

    <div id="downloadArea" class="download-area">
        <button id="dlPolyBtn" class="dl-btn" onclick="downloadPoly()">
            ğŸ—ºï¸ ãƒãƒªã‚´ãƒ³ã‚’DL
            <span id="dlPolyCount" class="dl-badge">(0ä»¶)</span>
        </button>
        <button id="dlPinBtn" class="dl-btn" onclick="downloadPin()">
            ğŸ“ ãƒ”ãƒ³ã‚’DL
            <span id="dlPinCount" class="dl-badge">(0ä»¶)</span>
        </button>
    </div>

    <textarea id="output" readonly placeholder="å‡¦ç†ãƒ­ã‚°ã‚„çµæœãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
</div>

<script>
    // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
    let storedFeatures = []; 
    let loadedFilesCount = 0;
    
    // çµæœä¿æŒç”¨
    let resultPolyGeoJSON = null;
    let resultPinGeoJSON = null;

    // --- ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼é–¢é€£ ---
    const readFile = (file) => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => {
            try { resolve({ name: file.name, data: JSON.parse(e.target.result) }); }
            catch (err) { reject(err); }
        };
        reader.readAsText(file);
    });

    const getFeatures = (json) => {
        if (!json) return [];
        if (json.type === 'FeatureCollection' && Array.isArray(json.features)) return json.features;
        if (Array.isArray(json)) return json;
        if (json.type === 'Feature') return [json];
        return [];
    };

    async function handleFiles(files) {
        if (!files || files.length === 0) return;
        const status = document.getElementById('status');
        status.style.display = 'none';

        for (let i = 0; i < files.length; i++) {
            try {
                const result = await readFile(files[i]);
                const features = getFeatures(result.data);
                features.forEach(f => storedFeatures.push(f));
                addToFileListUI(result.name, features);
            } catch (e) {
                alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${files[i].name}ã€ã®èª­ã¿è¾¼ã¿å¤±æ•—: ${e.message}`);
            }
        }
        document.getElementById('fileInput').value = '';
        updateCountDisplay();
    }

    function addToFileListUI(fileName, features) {
        const list = document.getElementById('fileList');
        if (loadedFilesCount === 0) list.innerHTML = '';

        let pCount = 0, polyCount = 0;
        features.forEach(f => {
            if (!f.geometry) return;
            const t = f.geometry.type;
            if (t === 'Point' || t === 'MultiPoint') pCount++;
            if (t === 'Polygon' || t === 'MultiPolygon') polyCount++;
        });

        const li = document.createElement('li');
        li.innerHTML = `
            <span>ğŸ“„ ${fileName}</span>
            <span>
                <span class="type-badge badge-pin">ğŸ“ ${pCount}</span>
                <span class="type-badge badge-poly">ğŸ—ºï¸ ${polyCount}</span>
            </span>
        `;
        list.appendChild(li);
        loadedFilesCount++;
    }

    function updateCountDisplay() {
        const pins = storedFeatures.filter(f => f.geometry && (f.geometry.type === 'Point' || f.geometry.type === 'MultiPoint')).length;
        const polys = storedFeatures.filter(f => f.geometry && (f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon')).length;
        document.getElementById('countDisplay').textContent = `${loadedFilesCount} ãƒ•ã‚¡ã‚¤ãƒ« (ãƒ‡ãƒ¼ã‚¿åˆè¨ˆ - ãƒ”ãƒ³: ${pins} / ãƒãƒªã‚´ãƒ³: ${polys})`;
    }

    function clearAllData() {
        if(!confirm("ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ")) return;
        storedFeatures = [];
        loadedFilesCount = 0;
        resultPolyGeoJSON = null;
        resultPinGeoJSON = null;
        document.getElementById('fileList').innerHTML = '<li style="color:#999; text-align:center;">ã¾ã ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“</li>';
        document.getElementById('countDisplay').textContent = '0 ãƒ•ã‚¡ã‚¤ãƒ« (ãƒ”ãƒ³: 0 / ãƒãƒªã‚´ãƒ³: 0)';
        document.getElementById('output').value = '';
        document.getElementById('status').style.display = 'none';
        document.getElementById('downloadArea').style.display = 'none';
    }

    // --- å¹¾ä½•è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ ---

    const getBBox = (coords, type) => {
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        const scan = (ring) => {
            for (const [x, y] of ring) {
                if (x < minX) minX = x;
                if (x > maxX) maxX = x;
                if (y < minY) minY = y;
                if (y > maxY) maxY = y;
            }
        };
        if (type === 'Polygon') scan(coords[0]);
        else if (type === 'MultiPolygon') coords.forEach(poly => scan(poly[0]));
        return { minX, maxX, minY, maxY };
    };

    const isPointInPoly = (pt, rings) => {
        const x = pt[0], y = pt[1];
        let inside = false;
        const ring = rings[0];
        for (let i = 0, j = ring.length - 1; i < ring.length; j = i++) {
            const xi = ring[i][0], yi = ring[i][1];
            const xj = ring[j][0], yj = ring[j][1];
            const intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
            if (intersect) inside = !inside;
        }
        return inside; 
    };

    const isPointInGeometry = (pt, geometry) => {
        if (geometry.type === 'Polygon') return isPointInPoly(pt, geometry.coordinates);
        if (geometry.type === 'MultiPolygon') return geometry.coordinates.some(coords => isPointInPoly(pt, coords));
        return false;
    };

    // --- ãƒ¡ã‚¤ãƒ³å‡¦ç† ---
    async function runProcess() {
        const strictMode = document.getElementById('strictMode').checked;
        const status = document.getElementById('status');
        const btn = document.getElementById('runBtn');
        const dlArea = document.getElementById('downloadArea');
        const outputText = document.getElementById('output');

        // ãƒ‡ãƒ¼ã‚¿åˆ†é¡
        const pins = storedFeatures.filter(f => f.geometry && (f.geometry.type === 'Point' || f.geometry.type === 'MultiPoint'));
        const polys = storedFeatures.filter(f => f.geometry && (f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon'));

        if (pins.length === 0 || polys.length === 0) {
            alert("ã‚¨ãƒ©ãƒ¼: ãƒ”ãƒ³ã¾ãŸã¯ãƒãƒªã‚´ãƒ³ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚");
            return;
        }

        status.style.display = 'block';
        status.className = 'status';
        status.textContent = "è¨ˆç®—ä¸­... (ãƒ‡ãƒ¼ã‚¿é‡ã«ã‚ˆã‚Šæ•°ç§’ã‹ã‹ã‚Šã¾ã™)";
        btn.disabled = true;
        dlArea.style.display = 'none';
        outputText.value = "";

        await new Promise(r => setTimeout(r, 50)); // UIæ›´æ–°å¾…ã¡

        try {
            const matchedPolys = [];
            const matchedPinSet = new Set(); // é‡è¤‡é˜²æ­¢ç”¨ (åŒã˜ãƒ”ãƒ³ãŒè¤‡æ•°ãƒãƒªã‚´ãƒ³ã«å«ã¾ã‚Œã‚‹å ´åˆãªã©)

            // ãƒ«ãƒ¼ãƒ—å‡¦ç†
            // å…¨ãƒãƒªã‚´ãƒ³ Ã— å…¨ãƒ”ãƒ³ ã‚’èµ°æŸ» (ãƒãƒªã‚´ãƒ³å†…ã®ã™ã¹ã¦ã®ãƒ”ãƒ³ã‚’å–å¾—ã™ã‚‹ãŸã‚ã€é€”ä¸­ã§breakã—ãªã„)
            for (const poly of polys) {
                const bbox = getBBox(poly.geometry.coordinates, poly.geometry.type);
                let polyHasPin = false;

                for (const pin of pins) {
                    // ãƒ”ãƒ³ã®åº§æ¨™å–å¾— (MultiPointã®å ´åˆã¯æœ€åˆã®ç‚¹ã®ã¿ç°¡æ˜“åˆ¤å®šã«ä½¿ç”¨ã€å³å¯†ã«ã¯å…¨ç‚¹ãƒ«ãƒ¼ãƒ—ãŒå¿…è¦ã ãŒé€šå¸¸Point)
                    let coordsList = [];
                    if(pin.geometry.type === 'Point') coordsList.push(pin.geometry.coordinates);
                    else if(pin.geometry.type === 'MultiPoint') coordsList = pin.geometry.coordinates;

                    for(const pt of coordsList) {
                        const [px, py] = pt;
                        
                        // 1. BBoxåˆ¤å®š (é«˜é€Ÿ)
                        if (px >= bbox.minX && px <= bbox.maxX && py >= bbox.minY && py <= bbox.maxY) {
                            let isMatch = false;
                            
                            // 2. å³å¯†åˆ¤å®š (ã¾ãŸã¯BBoxã®ã¿)
                            if (strictMode) {
                                if (isPointInGeometry(pt, poly.geometry)) isMatch = true;
                            } else {
                                isMatch = true;
                            }

                            if (isMatch) {
                                polyHasPin = true;
                                matchedPinSet.add(pin); // ãƒãƒƒãƒã—ãŸãƒ”ãƒ³ã‚’ä¿å­˜
                                // ã“ã“ã§ break ã™ã‚‹ã¨ã€ã€Œã“ã®ãƒãƒªã‚´ãƒ³ã«å«ã¾ã‚Œã‚‹ä»–ã®ãƒ”ãƒ³ã€ã®åˆ¤å®šãŒæ¼ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ break ã—ãªã„
                                // (ãŸã ã—ã€Œãƒãƒªã‚´ãƒ³æŠ½å‡ºã€ã ã‘ãŒç›®çš„ãªã‚‰ break ã—ãŸã»ã†ãŒé«˜é€Ÿ)
                                // ä»Šå›ã¯ã€Œãƒãƒƒãƒã—ãŸãƒ”ãƒ³ã€ã‚‚å…¨æ•°å‡ºã™å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€å…¨æ¢ç´¢ã«è¿‘ã„å½¢ã«ãªã‚Šã¾ã™ã€‚
                            }
                        }
                    }
                }
                
                if (polyHasPin) {
                    matchedPolys.push(poly);
                }
            }

            // çµæœä½œæˆ
            const matchedPins = Array.from(matchedPinSet);

            resultPolyGeoJSON = JSON.stringify({ type: "FeatureCollection", features: matchedPolys }, null, 2);
            resultPinGeoJSON = JSON.stringify({ type: "FeatureCollection", features: matchedPins }, null, 2);

            // å®Œäº†è¡¨ç¤º
            status.className = 'status success';
            status.innerHTML = `âœ… å®Œäº†ã—ã¾ã—ãŸ!<br>
                ãƒãƒƒãƒã—ãŸãƒãƒªã‚´ãƒ³: <b>${matchedPolys.length}</b> ä»¶<br>
                ã‚¨ãƒªã‚¢å†…ã®ãƒ”ãƒ³: <b>${matchedPins.length}</b> ä»¶`;

            // ãƒœã‚¿ãƒ³æ›´æ–°
            document.getElementById('dlPolyCount').textContent = `(${matchedPolys.length}ä»¶)`;
            document.getElementById('dlPinCount').textContent = `(${matchedPins.length}ä»¶)`;
            dlArea.style.display = 'flex';

            // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆç°¡æ˜“ï¼‰
            outputText.value = `--- å‡¦ç†çµæœã‚µãƒãƒªãƒ¼ ---\n` +
                               `åˆ¤å®šãƒ¢ãƒ¼ãƒ‰: ${strictMode ? "å³å¯†(Polygonåˆ¤å®š)" : "é«˜é€Ÿ(BBoxåˆ¤å®š)"}\n` +
                               `å…ƒãƒ‡ãƒ¼ã‚¿: ãƒãƒªã‚´ãƒ³${polys.length}ä»¶ / ãƒ”ãƒ³${pins.length}ä»¶\n` +
                               `------------------------\n` +
                               `ã€æŠ½å‡ºçµæœã€‘\n` +
                               `ãƒ»ãƒãƒªã‚´ãƒ³: ${matchedPolys.length} ä»¶ (ãƒ”ãƒ³ã‚’å«ã‚€ã‚¨ãƒªã‚¢)\n` +
                               `ãƒ»ãƒ”ãƒ³ã€€ã€€: ${matchedPins.length} ä»¶ (ã‚¨ãƒªã‚¢å†…ã®ãƒã‚¤ãƒ³ãƒˆ)\n\n` +
                               `(ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ãã‚Œãã‚Œã®GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™)`;

        } catch (e) {
            console.error(e);
            status.className = 'status error';
            status.textContent = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message;
        } finally {
            btn.disabled = false;
        }
    }

    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
    function downloadBlob(content, filename) {
        const blob = new Blob([content], {type: "application/geo+json"});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = filename;
        link.click();
    }

    function downloadPoly() {
        if (resultPolyGeoJSON) downloadBlob(resultPolyGeoJSON, 'extracted_polygons.geojson');
    }

    function downloadPin() {
        if (resultPinGeoJSON) downloadBlob(resultPinGeoJSON, 'extracted_pins.geojson');
    }
</script>

</body>
</html>
