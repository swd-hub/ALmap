<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>GeoJSONåœ°åŸŸåˆ¥ãƒ”ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        /* CSSã‚¹ã‚¿ã‚¤ãƒ«ã¯ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨ã»ã¼åŒã˜ã§ã™ */
        body { 
            font-family: sans-serif; 
            padding: 20px; 
            background-color: #f4f7f6;
        }
        h1 { color: #2c3e50; }
        h3 { color: #34495e; border-bottom: 2px solid #bdc3c7; padding-bottom: 5px; }
        #file-input { margin-bottom: 20px; padding: 15px; border: 1px solid #ccc; background-color: #ecf0f1; border-radius: 5px; }
        #address-selection { border: 1px solid #3498db; padding: 15px; margin-bottom: 20px; background-color: #eaf6ff; border-radius: 5px; }
        .radio-container { 
            max-height: 250px; 
            overflow-y: auto; 
            padding: 10px;
            border: 1px dashed #a8c1d9;
        }
        .radio-container div { margin-bottom: 5px; }
        input[type="radio"] { margin-right: 5px; }
        
        /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px; 
            background-color: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 10px; 
            text-align: left; 
            font-size: 14px;
        }
        th { 
            background-color: #3498db; 
            color: white; 
            position: sticky; top: 0; 
        }
        
        /* ãƒœã‚¿ãƒ³ã¨ã‚¢ãƒ©ãƒ¼ãƒˆ */
        button {
            padding: 10px 15px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }
        button:hover {
            background-color: #27ad60;
        }
        .download-button {
            background-color: #f39c12;
            margin-top: 10px;
            display: block;
            width: fit-content;
        }
        .download-button:hover {
            background-color: #e67e22;
        }
    </style>
</head>
<body>
    <h1>ğŸ—ºï¸ GeoJSONåœ°åŸŸåˆ¥ãƒ”ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ</h1>
    <p>GeoJSONãƒ•ã‚¡ã‚¤ãƒ« (`.geojson`, `.json`) ã‚’è¤‡æ•°é¸æŠã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã€å‡¦ç†ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚</p>

    <div id="file-input">
        <input type="file" id="geojsonFileInput" accept=".geojson,.json" multiple>
        <button onclick="processFiles()">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†</button>
    </div>

    <div id="address-selection">
        <h3>åœ°åŸŸé¸æŠ (åŠ å·¥æ¸ˆã¿ä½æ‰€)</h3>
        <p>â€»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†å¾Œã€ã“ã“ã«åœ°åŸŸãƒªã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ä¸‹ã®è¡¨ãŒæ›´æ–°ã•ã‚Œã¾ã™ã€‚</p>
        <div id="radioButtonsContainer" class="radio-container">
            </div>
    </div>

    <div id="result-area">
        <h3>é¸æŠã—ãŸåœ°åŸŸã®ãƒ‡ãƒ¼ã‚¿</h3>
        <p id="selectedAddressText">é¸æŠã•ã‚ŒãŸåœ°åŸŸï¼šãªã—</p>
        <button class="download-button" onclick="downloadGeoJson()" disabled id="downloadButton">
            é¸æŠãƒ‡ãƒ¼ã‚¿ã‚’ GeoJSON ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        </button>
        <div style="max-height: 400px; overflow-y: auto;">
            <table id="dataTable">
                </table>
        </div>
    </div>

    <script>
        // JavaScriptã‚³ãƒ¼ãƒ‰
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å…¨ãƒ•ã‚£ãƒ¼ãƒãƒ£ã‚’ä¿æŒã™ã‚‹é…åˆ—
        let allUniqueFeatures = [];
        // ä½æ‰€åŠ å·¥å¾Œã®ã‚­ãƒ¼ã¨å…ƒã®ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒªã‚¹ãƒˆã‚’ç´ã¥ã‘ã‚‹ãƒãƒƒãƒ—
        let groupedFeatures = new Map();

        // è¤‡æ•°ã®GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€çµåˆãƒ»å‡¦ç†ã™ã‚‹é–¢æ•°
        function processFiles() {
            const input = document.getElementById('geojsonFileInput');
            const files = input.files;
            if (files.length === 0) {
                alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸€ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            // å‡¦ç†å‰ã®åˆæœŸåŒ–
            allUniqueFeatures = [];
            groupedFeatures.clear();
            document.getElementById('radioButtonsContainer').innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>';
            document.getElementById('downloadButton').disabled = true;
            displayFilteredData(null);

            const filePromises = [];
            let combinedFeatures = [];

            // FileReaderã‚’ä½¿ã£ã¦å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€JSONã¨ã—ã¦ãƒ‘ãƒ¼ã‚¹ã™ã‚‹
            Array.from(files).forEach(file => {
                filePromises.push(new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            // GeoJSON FeatureCollectionã®featuresé…åˆ—ã‚’æŠ½å‡º
                            if (json.type === 'FeatureCollection' && Array.isArray(json.features)) {
                                combinedFeatures.push(...json.features);
                            } else if (json.type === 'Feature') {
                                // Featureå˜ä½“ã®å ´åˆã¯é…åˆ—ã«è¿½åŠ 
                                combinedFeatures.push(json);
                            } else {
                                console.warn(`Skipping file ${file.name}: Not a valid GeoJSON FeatureCollection or Feature.`);
                            }
                            resolve();
                        } catch(error) {
                            console.error(`Error parsing GeoJSON file ${file.name}:`, error);
                            reject(error);
                        }
                    };
                    reader.onerror = reject;
                    reader.readAsText(file); // GeoJSONã¯é€šå¸¸UTF-8
                }));
            });

            // å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ãŸã‚‰ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–ã¨ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ã‚’è¡Œã†
            Promise.all(filePromises)
                .then(() => {
                    if (combinedFeatures.length === 0) {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æœ‰åŠ¹ãªGeoJSONãƒ•ã‚£ãƒ¼ãƒãƒ£ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚');
                        document.getElementById('radioButtonsContainer').innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿ãªã—</p>';
                        return;
                    }
                    
                    // ğŸ’¡ 1. é‡è¤‡ãƒ‡ãƒ¼ã‚¿ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–
                    const uniqueFeaturesMap = new Map();
                    combinedFeatures.forEach(feature => {
                        // é‡è¤‡ãƒã‚§ãƒƒã‚¯ã¯ geometry + propertieså…¨ä½“ ã®JSONæ–‡å­—åˆ—ã§è¡Œã„ã¾ã™
                        const key = JSON.stringify({ geometry: feature.geometry, properties: feature.properties }); 
                        if (!uniqueFeaturesMap.has(key)) {
                            uniqueFeaturesMap.set(key, feature);
                        }
                    });
                    allUniqueFeatures = Array.from(uniqueFeaturesMap.values());
                    
                    // ğŸ’¡ 2. ä½æ‰€ã®åŠ å·¥ã¨ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°
                    allUniqueFeatures.forEach(feature => {
                        // propertiesã‹ã‚‰Addressåˆ—ã‚’æ¢ã™ (å¤§æ–‡å­—å°æ–‡å­—ã¯å³å¯†ã«)
                        const address = feature.properties ? feature.properties.Address : null;
                        
                        if (address && address !== "") { 
                            const cleanAddress = cleanAddressString(address);
                            
                            // åŠ å·¥å¾Œã®ä½æ‰€ã‚’ã‚­ãƒ¼ã¨ã—ã¦ãƒ•ã‚£ãƒ¼ãƒãƒ£ã‚’æ ¼ç´
                            if (!groupedFeatures.has(cleanAddress)) {
                                groupedFeatures.set(cleanAddress, []);
                            }
                            groupedFeatures.get(cleanAddress).push(feature);
                        }
                    });

                    // ğŸ’¡ 3. ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ç”Ÿæˆ
                    const uniqueAddresses = Array.from(groupedFeatures.keys());
                    renderRadioButtons(uniqueAddresses);
                    
                    // æœ€åˆã®ä½æ‰€ã‚’è‡ªå‹•é¸æŠã—ã¦è¡¨ç¤º
                    if (uniqueAddresses.length > 0) {
                         const firstAddress = uniqueAddresses[0];
                         displayFilteredData(firstAddress);
                         // æœ€åˆã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã«ã™ã‚‹
                         const firstRadio = document.querySelector('.radio-container input[type="radio"]');
                         if(firstRadio) firstRadio.checked = true;
                         document.getElementById('downloadButton').disabled = false;
                    } else {
                         displayFilteredData(null);
                    }
                    
                    alert(`âœ… GeoJSONå‡¦ç†å®Œäº†: åˆè¨ˆ ${combinedFeatures.length} ãƒ•ã‚£ãƒ¼ãƒãƒ£ã‹ã‚‰ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒ‡ãƒ¼ã‚¿ ${allUniqueFeatures.length} ä»¶ã‚’å‡¦ç†ã—ã€${uniqueAddresses.length} å€‹ã®åœ°åŸŸã«åˆ†é¡ã—ã¾ã—ãŸã€‚`);
                })
                .catch(error => {
                    console.error('ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:', error);
                    alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸã€‚è©³ç´°ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                });
        }

        // ä½æ‰€æ–‡å­—åˆ—ã‹ã‚‰æ•°å€¤ã¨ãƒã‚¤ãƒ•ãƒ³ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
        function cleanAddressString(address) {
            return address.replace(/[0-9-]+/g, '').trim(); 
        }

        // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªä½æ‰€ãƒªã‚¹ãƒˆã‹ã‚‰ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
        function renderRadioButtons(addresses) {
            const container = document.getElementById('radioButtonsContainer');
            container.innerHTML = ''; 

            if (addresses.length === 0) {
                container.innerHTML = '<p>ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªåœ°åŸŸãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ã€ŒAddressã€ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
                return;
            }

            addresses.forEach((address, index) => {
                const div = document.createElement('div');
                const radioId = `addr_${index}`;
                
                div.innerHTML = `
                    <input type="radio" id="${radioId}" name="cleanAddress" value="${address}" 
                           onclick="displayFilteredData(this.value)">
                    <label for="${radioId}">${address} (${groupedFeatures.get(address).length} ä»¶)</label>
                `;
                container.appendChild(div);
            });
        }

        // é¸æŠã•ã‚ŒãŸä½æ‰€ã«åŸºã¥ã„ã¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã€è¡¨ã«å‡ºåŠ›ã™ã‚‹é–¢æ•°
        let currentSelectedFeatures = []; // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ã«é¸æŠä¸­ã®ãƒ•ã‚£ãƒ¼ãƒãƒ£ã‚’ä¿æŒ
        
        function displayFilteredData(selectedAddress) {
            const table = document.getElementById('dataTable');
            const selectedAddressText = document.getElementById('selectedAddressText');
            table.innerHTML = ''; 
            currentSelectedFeatures = []; // ãƒªã‚»ãƒƒãƒˆ
            
            if (!selectedAddress) {
                selectedAddressText.textContent = 'é¸æŠã•ã‚ŒãŸåœ°åŸŸï¼šãªã—';
                document.getElementById('downloadButton').disabled = true;
                table.innerHTML = '<thead><tr><th>ãƒ‡ãƒ¼ã‚¿ãªã—</th></tr></thead><tbody></tbody>';
                return;
            }

            selectedAddressText.textContent = `é¸æŠã•ã‚ŒãŸåœ°åŸŸï¼š${selectedAddress}`;
            const filteredData = groupedFeatures.get(selectedAddress) || [];
            currentSelectedFeatures = filteredData; // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ãƒ‡ãƒ¼ã‚¿ã«è¨­å®š
            
            if (filteredData.length === 0) {
                document.getElementById('downloadButton').disabled = true;
                table.innerHTML = '<thead><tr><th>ãƒ‡ãƒ¼ã‚¿ãªã—</th></tr></thead><tbody><tr><td>é¸æŠã•ã‚ŒãŸåœ°åŸŸã«è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td></tr></tbody>';
                return;
            }
            
            document.getElementById('downloadButton').disabled = false;
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºç”¨ã®å‡¦ç† (GeoJSON propertiesã‚’å±•é–‹)
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ä½œæˆ: propertiesã®ã‚­ãƒ¼ + Geometry (ç·¯åº¦/çµŒåº¦)
            const firstProps = filteredData[0].properties || {};
            let headers = Object.keys(firstProps);
            // ç·¯åº¦çµŒåº¦ã‚’ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«è¿½åŠ  (ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºç”¨)
            if(filteredData[0].geometry && filteredData[0].geometry.coordinates) {
                 headers = [...headers, 'Longitude', 'Latitude'];
            }

            const thead = table.createTHead();
            let headerRow = thead.insertRow();
            headers.forEach(header => {
                let th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            
            // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ä½œæˆ
            const tbody = table.createTBody();
            filteredData.forEach(feature => {
                let tr = tbody.insertRow();
                const props = feature.properties || {};
                const coords = feature.geometry && feature.geometry.coordinates;

                headers.forEach(header => {
                    let td = tr.insertCell();
                    if (header === 'Longitude' && coords) {
                        td.textContent = coords[0]; // çµŒåº¦
                    } else if (header === 'Latitude' && coords) {
                        td.textContent = coords[1]; // ç·¯åº¦
                    } else {
                        td.textContent = props[header] || ''; // ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å€¤
                    }
                });
            });
        }
        
        // ğŸ’¡ 4. é¸æŠã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒãƒ£ã‚’GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹é–¢æ•°
        function downloadGeoJson() {
            if (currentSelectedFeatures.length === 0) {
                alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
                return;
            }

            // FeatureCollectionå½¢å¼ã®GeoJSONã‚’ä½œæˆ
            const geoJsonOutput = {
                type: "FeatureCollection",
                features: currentSelectedFeatures
            };

            const dataStr = JSON.stringify(geoJsonOutput, null, 2); // æ•´å½¢ã—ã¦æ–‡å­—åˆ—åŒ–
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            
            const selectedAddress = document.getElementById('selectedAddressText').textContent.replace('é¸æŠã•ã‚ŒãŸåœ°åŸŸï¼š', '').trim();
            const filename = `filtered_${selectedAddress || 'data'}_${Date.now()}.geojson`;
            
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>