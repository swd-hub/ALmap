<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>作物ごとに色分け圃場ハイライト＋ファイル入出力サンプル</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { display: flex; margin: 0; }
    #map { width: 70%; height: 100vh; }
    #info { width: 30%; height: 100vh; overflow:auto; border-left: 1px solid #ccc; padding: 10px; }
    table { border-collapse: collapse; width: 100%; }
    td { border: 1px solid #ccc; padding: 4px; }
    .tiban-label {
      background: rgba(255,255,255,0.85);
      padding: 2px 8px;
      border: 1px solid #333;
      border-radius: 3px;
      font-size: 14px;
      pointer-events: none;
      font-weight: bold;
      white-space: nowrap;
    }
    #legend label {
      margin: 4px;
      display: inline-block;
      cursor: pointer;
    }
    #legend span {
      display:inline-block;width:18px;height:18px;border-radius:3px;margin-right:4px;vertical-align:middle;
      border:1px solid #333;
    }
    #outbtn {
      margin: 8px 0;
      width: 100%;
      height: 36px;
      font-size: 16px;
      background: #f8c363;
      border: 1px solid #d98400;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="info">
    <h3>選択した情報</h3>
    <div id="details">GeoJSONファイルを選択し、圃場をクリックしてください</div>
    <hr>

    <!-- ★ 総面積表示をここに追加 ★ -->
    <div id="coloredArea"><b>着色済み総面積：</b> 0 ㎡</div>
    <hr>

    <!-- ファイル選択ボタン -->
    <input type="file" id="fileInput" accept=".geojson,.json" multiple />
    <hr>

    <div id="legend"></div>
    <button id="outbtn">表示中の圃場をGeoJSONで保存</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</body>

<script>
/*------------------------------------------------------
  タイルレイヤー
------------------------------------------------------*/
const osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 19, attribution: "© OpenStreetMap"
});

const esriSat = L.tileLayer(
  "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",
  { attribution: "Tiles © Esri" }
);

const map = L.map("map", {
  center: [35.404, 132.825],
  zoom: 16,
  layers: [osm]
});

const polygonLayerGroup = L.layerGroup().addTo(map);
const markerLayerGroup  = L.layerGroup().addTo(map);
const tibanLayerGroup   = L.layerGroup().addTo(map);

const baseMaps = { 
  "地図（OSM）": osm, 
  "衛星（ESRI）": esriSat 
};
const overlayMaps = {
  "圃場ポリゴン": polygonLayerGroup,
  "地番ラベル": tibanLayerGroup
};

L.control.layers(baseMaps, overlayMaps).addTo(map);

/*------------------------------------------------------
  作物ラジオ UI
------------------------------------------------------*/
const cropColors = {
  "主食用きぬむすめ": "#e57373",
  "主食用こしひかり": "#f06292",
  "稲WCS用きぬむすめ": "#ba68c8",
  "稲WCS用つきはやか": "#64b5f6",
  "飼料用米": "#4dd0e1",
  "大麦": "#4db6ac",
  "小麦": "#81c784",
  "ブロッコリー": "#dce775",
  "タマネギ": "#ffd54f",
  "デントコーン": "#ffb74d",
  "はとむぎ": "#a1887f",
  "さつまいも": "#f4511e",
  "大豆": "#789262",
  "その他": "#bdbdbd"
};

function createCropLegend(crops) {
  const legendDiv = document.getElementById("legend");
  let html = "<h4>作物（ラジオ選択して圃場着色）</h4>";
  crops.forEach((crop, i) => {
    html += `<label>
      <input type="radio" name="crop" value="${crop}" ${i===0 ? "checked":""}>
      <span style="background:${cropColors[crop]};"></span>
      ${crop}
    </label><br>`;
  });
  legendDiv.innerHTML = html;
}
createCropLegend(Object.keys(cropColors));

function getSelectedCrop() {
  const checked = document.querySelector('input[name="crop"]:checked');
  return checked ? checked.value : null;
}

/*------------------------------------------------------
  プロパティ表示
------------------------------------------------------*/
 // 英→日ラベル辞書（FarmCommitteeCd追加）
    const propertyLabels = {
      // 主項目・参考画像・日本語訳対応
      Address:        "所在地",
      Tiban:          "地番",
      ClassificationOfLandCodeName: "地目",
      AreaOnRegistry: "面積（㎡）",
      SectionOfNoushinhouCodeName: "農振法区分",
      SectionOfToshikeikakuhouCodeName: "都市計画区分",
      OwnerFarmIntentionCodeName: "所有者の農地に関する意向",
      FarmerIndicationNumberHash: "耕作管理番号",
      KindOfRightCodeName:      "権利種別",
      KindOfRight:              "権利の種類",
      CommencementDate:         "存続期間の開始日",
      EndStagesDate:            "存続期間の終了日",
      RightSettingContentsCodeName: "農地中間管理権等権利設定の内容",
      UsageSituationInvestigationResultCodeName: "遊休農地関係（利用状況調査等）",
      UsageSituationInvestigationDate:   "利用状況調査日",
      UseIntentionInvestigationDate:     "利用意向調査日",
      OwnerStatementIntentSurveyResultsCodeName: "遊休農地関係（利用意向調査等）",
      UseIntentionAscertainmentResultCodeName:   "遊休農地関係（周辺地域への支障の除去等の指導）",
      ActionOrderDate:        "指導命令日",
      MayorPublicAnnouncementDate: "市町村長が措置を行う旨の公示を行った日",
      FarmCommitteeName:      "農業委員会名",
      FarmCommitteeCd:        "農業委員会コード",
      PublicNoticeDate:       "公告日",
      SectionOfPolygon:        "筆区分",
      SectionOfPolygonCodeName:"筆区分名",
      DaichoId:               "台帳ID",
      polygon_uuid:           "ポリゴンUUID",
      daicho_shubetsu_cd:     "台帳種別コード",
      SectionOfNoushinhou:    "農振法区分コード",
      SectionOfToshikeikakuhou:"都市計画法区分コード",
      AreaOnRegistryHa: "面積（ヘクタール）",
      ClassificationOfLand:   "地目コード",
      SectionOfPolygonName:   "筆区分名",
      UsageSituationInvestigationResult: "利用状況調査結果コード",
      OwnerStatementIntentSurveyResults: "所有者等の廃地の状況",
      UseIntentionAscertainmentResult: "利用意向把握結果コード",
      RecommendationContenDate: "勧告内容日",
      RightOfMiddleManagement: "農地中間管理権の状況",
      OazaCode: "大字コード",
      TodofukenCode: "都道府県コード",
      ShikuchosonCode: "市区町村コード"
    };

function showProperties(props) {
  let html = "<table>";
  for (const key in props) {
    const jp = propertyLabels[key] ?? "（訳なし）";
    html += `<tr><td>${key}<br><span style='font-size:11px;color:#444'>${jp}</span></td><td>${props[key]}</td></tr>`;
  }
  html += "</table>";

  document.getElementById("details").innerHTML = html;
}

/*------------------------------------------------------
  ハイライト
------------------------------------------------------*/
let highlightLayer = null;

function highlightFeature(feature) {
  if (highlightLayer) {
    map.removeLayer(highlightLayer);
    highlightLayer = null;
  }
  highlightLayer = L.geoJSON(feature, {
    style: {
      color: '#0057ff',
      weight: 4,
      fillColor: '#3399ff',
      fillOpacity: 0.3
    }
  }).addTo(map);
}

/*------------------------------------------------------
  着色された総面積を計算して表示
------------------------------------------------------*/
function updateColoredArea() {
  let totalArea = 0;
  console.log("=== updateColoredArea START ===");

  // Polygon の合計
  polygonLayerGroup.eachLayer(function(lyr) {
    const f = lyr.feature;
    if (f && f.properties && f.properties.SelectedCrop) {
      let a = f.properties.AreaOnRegistry;
      if (typeof a === "string") a = a.replace(/[^\d.]/g, "");
      a = Number(a);
      if (!isNaN(a)) {
        totalArea += a;
        console.log("Polygon加算:", f.properties.Tiban, a);
      }
    }
  });

  // Point の合計
  markerLayerGroup.eachLayer(function(lyr) {
    const f = lyr.feature;
    if (f && f.properties && f.properties.SelectedCrop) {
      let a = f.properties.AreaOnRegistry;
      if (typeof a === "string") a = a.replace(/[^\d.]/g, "");
      a = Number(a);
      if (!isNaN(a)) {
        totalArea += a;
        console.log("Point加算:", f.properties.Tiban, a);
      }
    }
  });

  console.log("=== updateColoredArea END === totalArea =", totalArea);

  const areaDiv = document.getElementById("coloredArea");
  if (areaDiv) {
    areaDiv.innerHTML = `<b>着色済み総面積：</b> ${Math.round(totalArea).toLocaleString()} ㎡`;
  }
}

/*------------------------------------------------------
  GeoJSON 読み込み
------------------------------------------------------*/
document.getElementById("fileInput").addEventListener("change", function(event) {
  const files = event.target.files;

  for (const file of files) {
    const reader = new FileReader();

    reader.onload = function(e) {
      let geojson;
      try {
        geojson = JSON.parse(e.target.result);
      } catch {
        alert("ファイル読み込み失敗: " + file.name);
        return;
      }

      L.geoJSON(geojson, {
        style: function(feature) {
          if (feature.geometry.type === "Polygon" || feature.geometry.type === "MultiPolygon") {
            const crop = feature.properties?.SelectedCrop;
            return {
              color: "#d00",
              weight: 2,
              fillColor: cropColors[crop] || "#e88",
              fillOpacity: crop ? 0.7 : 0.3
            };
          }
        },

        onEachFeature: function(feature, lyr) {
          /*-----------------------------------------------
             ◆ ポリゴン（クリックで色の ON/OFF）
          -----------------------------------------------*/
          if (feature.geometry.type === "Polygon" || feature.geometry.type === "MultiPolygon") {
            polygonLayerGroup.addLayer(lyr);

            // 地番ラベル
            const coords = feature.geometry.type === "Polygon"
              ? feature.geometry.coordinates[0][0]
              : feature.geometry.coordinates[0][0][0];
            if (coords) {
              const tibanLabel = L.marker([coords[1], coords[0]], {
                icon: L.divIcon({
                  className: "tiban-label",
                  html: String(feature.properties?.Tiban || ""),
                  iconSize: null
                }),
                interactive: false
              });
              tibanLayerGroup.addLayer(tibanLabel);
            }

            // ★★★ クリック：着色 ⇄ 解除 ★★★
            lyr.on("click", function() {
              const crop = getSelectedCrop();
              const f = lyr.feature;

              if (f.properties.SelectedCrop) {
                f.properties.SelectedCrop = null;
                lyr.setStyle({ fillColor: "#e88", fillOpacity: 0.3, color: "#d00", weight: 2 });
              } else if (crop && cropColors[crop]) {
                f.properties.SelectedCrop = crop;
                lyr.setStyle({ fillColor: cropColors[crop], fillOpacity: 0.7, color: "#111", weight: 3 });
              }

              showProperties(f.properties);
              updateColoredArea();
            });
          }

          /*-----------------------------------------------
             ◆ ポイント（クリックで色の ON/OFF）
          -----------------------------------------------*/
          else if (feature.geometry.type === "Point") {
            const latlng = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];
            const marker = L.marker(latlng);
            marker.feature = feature;
            markerLayerGroup.addLayer(marker);

            marker.on("click", function() {
              const crop = getSelectedCrop();
              const f = marker.feature;

              if (f && f.properties) {
                if (f.properties.SelectedCrop) {
                  f.properties.SelectedCrop = null;
                  marker.setIcon(L.divIcon({
                    className: "tiban-label",
                    html: String(f.properties.Tiban || ""),
                    iconSize: null
                  }));
                } else if (crop && cropColors[crop]) {
                  f.properties.SelectedCrop = crop;
                  marker.setIcon(L.divIcon({
                    className: "tiban-label",
                    html: `<span style="background:${cropColors[crop]};padding:2px 6px;border-radius:3px;">${f.properties.Tiban || ""}</span>`,
                    iconSize: null
                  }));
                }
                showProperties(f.properties);
                updateColoredArea();
              }
            });

            if (feature.properties?.Tiban) {
              const tibanLabel = L.marker(latlng, {
                icon: L.divIcon({
                  className: "tiban-label",
                  html: String(feature.properties.Tiban),
                  iconSize: null
                }),
                interactive: false
              });
              tibanLayerGroup.addLayer(tibanLabel);
            }
          }
        } // ← onEachFeature を閉じる
      });   // ← L.geoJSON を閉じる
    };      // ← reader.onload を閉じる
    reader.readAsText(file);
  }
});       // ← addEventListener を閉じる


</script>
</body>
</html>
