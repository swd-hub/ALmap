<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSVçµã‚Šè¾¼ã¿ & ç©ºé–“æŠ½å‡ºãƒ„ãƒ¼ãƒ« (ä¿®æ­£ç‰ˆ)</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            margin: 20px;
            background-color: #f4f6f9;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 15px;
        }
        .container {
            max-width: 950px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 5px solid #007bff;
        }
        h2 {
            font-size: 1.2em;
            color: #007bff;
            margin-top: 0;
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .file-input-wrapper {
            margin-bottom: 15px;
        }
        input[type="file"] {
            display: block;
            width: 100%;
            padding: 10px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        /* ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .file-list-box {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            max-height: 150px;
            overflow-y: auto;
        }
        .file-list-box ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .file-list-box li {
            padding: 4px 0;
            border-bottom: 1px dashed #eee;
            font-size: 0.95em;
            color: #555;
            display: flex;
            justify-content: space-between;
        }
        .file-list-box li:last-child {
            border-bottom: none;
        }
        .file-size {
            color: #999;
            font-size: 0.85em;
        }
        .empty-msg {
            color: #aaa;
            font-style: italic;
            text-align: center;
            padding: 10px;
        }

        button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        button:hover {
            background-color: #218838;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .clear-btn {
            background-color: #dc3545;
            padding: 5px 10px;
            font-size: 12px;
            width: auto;
            margin-top: 5px;
            float: right;
        }
        .clear-btn:hover {
            background-color: #c82333;
        }

        .output-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .output-box {
            flex: 1;
        }
        textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            background-color: #fafafa;
            box-sizing: border-box;
        }
        .download-btn {
            background-color: #17a2b8;
            margin-top: 10px;
            padding: 10px;
            font-size: 14px;
        }
        .download-btn:hover {
            background-color: #138496;
        }
        .message {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            display: none;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .note { font-size: 0.9em; color: #666; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>CSVçµã‚Šè¾¼ã¿ & ç©ºé–“æŠ½å‡ºãƒ„ãƒ¼ãƒ« (ä¿®æ­£ç‰ˆ)</h1>
        <p>ãƒ”ãƒ³ã¨ãƒãƒªã‚´ãƒ³ã‚’å«ã‚€GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…¥åŠ›ã—ã€<br>
           <b>â‘  CSVã§ãƒ”ãƒ³ã‚’çµã‚Šè¾¼ã¿</b> â†’ <b>â‘¡ ãã®ãƒ”ãƒ³ãŒå«ã¾ã‚Œã‚‹ãƒãƒªã‚´ãƒ³ã®ã¿ã‚’æŠ½å‡º</b> ã—ã¾ã™ã€‚</p>

        <div class="section">
            <h2>ğŸ“‚ 1. GeoJSONãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› (æ··åˆå¯)</h2>
            <div class="file-input-wrapper">
                <label>GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ  (.json, .geojson)</label>
                <input type="file" id="geoFileInput" accept=".json,.geojson" multiple onchange="addGeoFiles()">
                
                <div style="overflow: hidden;">
                    <p class="note" style="float:left;">â€» ãƒ”ãƒ³(Point)ã¨ãƒãƒªã‚´ãƒ³(Polygon)ã¯è‡ªå‹•åˆ¤åˆ¥ã•ã‚Œã¾ã™ã€‚</p>
                    <button onclick="clearGeoFiles()" class="clear-btn">ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢</button>
                </div>

                <div class="file-list-box">
                    <ul id="geoFileList">
                        <li class="empty-msg">ã¾ã ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</li>
                    </ul>
                </div>
            </div>

            <h2>ğŸ“ 2. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç”¨CSVå…¥åŠ›</h2>
            <div class="file-input-wrapper">
                <label>ä½æ‰€ãƒªã‚¹ãƒˆCSV (.csv)</label>
                <input type="file" id="csvFile" accept=".csv" onchange="updateCsvLabel()">
                <p id="csvFileName" class="note" style="color: #007bff; font-weight: bold;"></p>
                <p class="note">â€» 1åˆ—ç›®ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ãƒ”ãƒ³ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’æ¤œç´¢ã—ã€ä¸€è‡´ã™ã‚‹ãƒ”ãƒ³ã®ã¿ã‚’æ®‹ã—ã¾ã™ã€‚</p>
            </div>
        </div>

        <button onclick="executeProcess()" id="runBtn">å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹</button>
        
        <div id="statusMsg" class="message"></div>

        <div class="output-container">
            <div class="output-box">
                <h3>ğŸ“ çµæœ 1: çµã‚Šè¾¼ã¾ã‚ŒãŸãƒ”ãƒ³</h3>
                <textarea id="outPins" readonly placeholder="CSVã«ã‚ˆã‚Šãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã•ã‚ŒãŸãƒ”ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
                <button onclick="download('pins')" class="download-btn" id="dlPins" style="display:none;">ãƒ”ãƒ³ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
            <div class="output-box">
                <h3>ğŸ—ºï¸ çµæœ 2: æŠ½å‡ºã•ã‚ŒãŸãƒãƒªã‚´ãƒ³</h3>
                <textarea id="outPolys" readonly placeholder="ãƒ”ãƒ³ã®ç¯„å›²ã«å«ã¾ã‚Œã‚‹ãƒãƒªã‚´ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
                <button onclick="download('polys')" class="download-btn" id="dlPolys" style="display:none;">ãƒãƒªã‚´ãƒ³ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let inputGeoJsonFiles = []; // é¸æŠã•ã‚ŒãŸGeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿æŒã™ã‚‹é…åˆ—
        let resultPinsJson = "";
        let resultPolysJson = "";

        // -------------------------------------------------
        // UIæ“ä½œé–¢é€£ (ãƒ•ã‚¡ã‚¤ãƒ«è¿½åŠ è¡¨ç¤ºãªã©)
        // -------------------------------------------------

        // GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¦ãƒªã‚¹ãƒˆè¡¨ç¤ºæ›´æ–°
        function addGeoFiles() {
            const input = document.getElementById('geoFileInput');
            if (input.files.length > 0) {
                // æ—¢å­˜ã®ãƒªã‚¹ãƒˆã«æ–°ã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
                inputGeoJsonFiles = inputGeoJsonFiles.concat(Array.from(input.files));
                renderGeoFileList();
            }
            // åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸ã¹ã‚‹ã‚ˆã†ã«inputå€¤ã‚’ãƒªã‚»ãƒƒãƒˆ
            input.value = ''; 
        }

        // GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’ç”»é¢ã«æç”»
        function renderGeoFileList() {
            const listEl = document.getElementById('geoFileList');
            listEl.innerHTML = '';

            if (inputGeoJsonFiles.length === 0) {
                listEl.innerHTML = '<li class="empty-msg">ã¾ã ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</li>';
                return;
            }

            inputGeoJsonFiles.forEach(file => {
                const li = document.createElement('li');
                // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’KB/MBè¨ˆç®—
                let sizeStr = "";
                if(file.size < 1024 * 1024) {
                    sizeStr = (file.size / 1024).toFixed(1) + " KB";
                } else {
                    sizeStr = (file.size / (1024 * 1024)).toFixed(1) + " MB";
                }
                
                li.innerHTML = `<span>ğŸ“„ ${file.name}</span> <span class="file-size">${sizeStr}</span>`;
                listEl.appendChild(li);
            });
        }

        // GeoJSONãƒªã‚¹ãƒˆã‚¯ãƒªã‚¢
        function clearGeoFiles() {
            inputGeoJsonFiles = [];
            renderGeoFileList();
        }

        // CSVãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®è¡¨ç¤ºæ›´æ–°
        function updateCsvLabel() {
            const input = document.getElementById('csvFile');
            const label = document.getElementById('csvFileName');
            if(input.files.length > 0) {
                label.textContent = `é¸æŠä¸­: ${input.files[0].name}`;
            } else {
                label.textContent = "";
            }
        }

        // -------------------------------------------------
        // ãƒ¡ã‚¤ãƒ³å‡¦ç†é–¢æ•°
        // -------------------------------------------------
        async function executeProcess() {
            const csvInput = document.getElementById('csvFile');
            const runBtn = document.getElementById('runBtn');
            const statusDiv = document.getElementById('statusMsg');

            // UIåˆæœŸåŒ–
            statusDiv.style.display = 'none';
            document.getElementById('dlPins').style.display = 'none';
            document.getElementById('dlPolys').style.display = 'none';
            document.getElementById('outPins').value = '';
            document.getElementById('outPolys').value = '';

            // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (inputGeoJsonFiles.length === 0) {
                showMsg("âŒ GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚", true);
                return;
            }
            if (csvInput.files.length === 0) {
                showMsg("âŒ ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç”¨ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚", true);
                return;
            }

            runBtn.disabled = true;
            runBtn.textContent = "å‡¦ç†ä¸­...";

            try {
                // 1. CSVã®èª­ã¿è¾¼ã¿
                const csvText = await readFile(csvInput.files[0]);
                const targetAddresses = parseCsv(csvText);
                if (targetAddresses.length === 0) {
                    throw new Error("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ï¼ˆä½æ‰€ãªã©ï¼‰ã‚’èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚");
                }

                // 2. GeoJSONã®èª­ã¿è¾¼ã¿ã¨åˆ†é¡
                const { pins, polygons } = await loadAndSplitGeoJson(inputGeoJsonFiles);

                if (pins.length === 0) {
                    throw new Error("èª­ã¿è¾¼ã‚“ã ãƒ•ã‚¡ã‚¤ãƒ«ã«ã€ŒPoint (ãƒ”ãƒ³)ã€ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                }
                if (polygons.length === 0) {
                    throw new Error("èª­ã¿è¾¼ã‚“ã ãƒ•ã‚¡ã‚¤ãƒ«ã«ã€ŒPolygon (ãƒãƒªã‚´ãƒ³)ã€ãƒ‡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
                }

                // 3. CSVã«ã‚ˆã‚‹ãƒ”ãƒ³ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                const filteredPins = pins.filter(pin => {
                    const propStr = JSON.stringify(pin.properties || "");
                    return targetAddresses.some(addr => propStr.indexOf(addr) !== -1);
                });

                if (filteredPins.length === 0) {
                    throw new Error("CSVã®æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒ”ãƒ³ãŒ1ä»¶ã‚‚ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
                }

                // ----------------------------------------------------------
                // ä¿®æ­£ç®‡æ‰€: ã“ã“ã§ã€Œå…¨ä½“ã®BBoxã€ã§ã¯ãªãã€Œå„ãƒãƒªã‚´ãƒ³ã”ã¨ã®åŒ…å«åˆ¤å®šã€ã‚’è¡Œã†
                // ----------------------------------------------------------
                
                // 4. æ®‹ã£ãŸãƒ”ãƒ³ã®åº§æ¨™ãƒªã‚¹ãƒˆã‚’ä½œæˆï¼ˆé«˜é€ŸåŒ–ã®ãŸã‚ï¼‰
                const pinCoords = filteredPins.map(p => p.geometry.coordinates);

                // 5. ãƒãƒªã‚´ãƒ³ã‚’ä¸€ã¤ãšã¤ãƒã‚§ãƒƒã‚¯ã—ã€ä¸­ã«ãƒ”ãƒ³ãŒå«ã¾ã‚Œã‚‹ã‹ç¢ºèª
                const matchedPolygons = polygons.filter(poly => {
                    // ãã®ãƒãƒªã‚´ãƒ³ã®BBoxã‚’è¨ˆç®— [minX, minY, maxX, maxY]
                    const polyBBox = calculateBBox([poly]); 
                    if (!polyBBox) return false;
                    
                    const [minX, minY, maxX, maxY] = polyBBox;

                    // æ®‹ã£ãŸãƒ”ãƒ³ã®ã†ã¡ã€ã²ã¨ã¤ã§ã‚‚ã“ã®ãƒãƒªã‚´ãƒ³ã®BBoxå†…ã«ã‚ã‚‹ã‹ï¼Ÿ
                    // (è©³ç´°ãªå½¢çŠ¶åˆ¤å®šã¯é‡ããªã‚‹ãŸã‚ã€ã‚³ãƒ¼ãƒ‰2ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œã«åˆã‚ã›ã¦BBoxåˆ¤å®šã‚’æ¡ç”¨)
                    return pinCoords.some(([px, py]) => {
                        return px >= minX && px <= maxX && py >= minY && py <= maxY;
                    });
                });

                // ----------------------------------------------------------

                // 6. çµæœã®ç”Ÿæˆ
                const finalPinsGeoJSON = { type: "FeatureCollection", features: filteredPins };
                const finalPolysGeoJSON = { type: "FeatureCollection", features: matchedPolygons };

                resultPinsJson = JSON.stringify(finalPinsGeoJSON, null, 2);
                resultPolysJson = JSON.stringify(finalPolysGeoJSON, null, 2);

                // 7. è¡¨ç¤ºã¨å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                document.getElementById('outPins').value = resultPinsJson;
                document.getElementById('outPolys').value = resultPolysJson;
                document.getElementById('dlPins').style.display = 'inline-block';
                document.getElementById('dlPolys').style.display = 'inline-block';

                showMsg(
                    `âœ… å‡¦ç†æˆåŠŸï¼\n` +
                    `--------------------------------------\n` +
                    `ğŸ“¥ å…¥åŠ›ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${inputGeoJsonFiles.length}ä»¶\n` +
                    `ğŸ“‹ CSVãƒ•ã‚£ãƒ«ã‚¿: ${targetAddresses.length}ä»¶ã®æ¡ä»¶ã‚’ä½¿ç”¨\n` +
                    `â¬‡\n` +
                    `ğŸ“ çµã‚Šè¾¼ã¿ãƒ”ãƒ³: ${filteredPins.length}ä»¶ (å…¨${pins.length}ä»¶ä¸­)\n` +
                    `ğŸ—ºï¸ æŠ½å‡ºãƒãƒªã‚´ãƒ³: ${matchedPolygons.length}ä»¶ (å…¨${polygons.length}ä»¶ä¸­)\n` +
                    `\n(å„ãƒãƒªã‚´ãƒ³ã®ç¯„å›²å†…ã«ã€æœ‰åŠ¹ãªãƒ”ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‚‚ã®ã®ã¿æŠ½å‡ºã—ã¾ã—ãŸ)`
                );

            } catch (err) {
                console.error(err);
                showMsg(`âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n${err.message}`, true);
            } finally {
                runBtn.disabled = false;
                runBtn.textContent = "å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹";
            }
        }

        // -------------------------------------------------
        // ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ç¾¤
        // -------------------------------------------------

        // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿
        function readFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = () => reject(new Error(`${file.name} ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ`));
                reader.readAsText(file);
            });
        }

        // CSVãƒ‘ãƒ¼ã‚¹
        function parseCsv(text) {
            return text.split(/\r?\n/)
                .map(line => line.split(',')[0].trim())
                .filter(val => val !== "");
        }

        // GeoJSONèª­ã¿è¾¼ã¿ & ãƒ”ãƒ³/ãƒãƒªã‚´ãƒ³åˆ†é›¢
        async function loadAndSplitGeoJson(fileList) {
            let pins = [];
            let polygons = [];

            for (const file of fileList) {
                try {
                    const text = await readFile(file);
                    const json = JSON.parse(text);
                    
                    const features = (json.type === "FeatureCollection" && Array.isArray(json.features)) 
                                     ? json.features 
                                     : (json.type === "Feature" ? [json] : []);

                    features.forEach(f => {
                        if (!f.geometry) return;
                        if (f.geometry.type === "Point") {
                            pins.push(f);
                        } else if (f.geometry.type === "Polygon" || f.geometry.type === "MultiPolygon") {
                            polygons.push(f);
                        }
                    });
                } catch (e) {
                    console.warn(`ãƒ•ã‚¡ã‚¤ãƒ« ${file.name} ã¯æœ‰åŠ¹ãªGeoJSONã§ã¯ãªã„ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸã€‚`);
                }
            }
            return { pins, polygons };
        }

        // BBoxè¨ˆç®— (ãƒãƒªã‚´ãƒ³ã®ç¯„å›² [minLng, minLat, maxLng, maxLat] ã‚’è¿”ã™)
        function calculateBBox(features) {
            let minLng = Infinity, maxLng = -Infinity;
            let minLat = Infinity, maxLat = -Infinity;

            const updateBounds = (lng, lat) => {
                minLng = Math.min(minLng, lng);
                maxLng = Math.max(maxLng, lng);
                minLat = Math.min(minLat, lat);
                maxLat = Math.max(maxLat, lat);
            };

            features.forEach(f => {
                const coords = f.geometry.coordinates;
                const type = f.geometry.type;

                if (type === 'Point') {
                    updateBounds(coords[0], coords[1]);
                } else {
                    const traverse = (arr) => {
                        if (typeof arr[0] === 'number') {
                            updateBounds(arr[0], arr[1]);
                        } else {
                            arr.forEach(traverse);
                        }
                    };
                    traverse(coords);
                }
            });

            if (minLng === Infinity) return null;
            return [minLng, minLat, maxLng, maxLat];
        }

        function showMsg(text, isError = false) {
            const div = document.getElementById('statusMsg');
            div.textContent = text;
            div.className = isError ? "message error" : "message success";
            div.style.display = "block";
        }

        function download(type) {
            const content = (type === 'pins') ? resultPinsJson : resultPolysJson;
            const fileName = (type === 'pins') ? "filtered_pins.geojson" : "matched_polygons.geojson";
            
            const blob = new Blob([content], { type: "application/geo+json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
