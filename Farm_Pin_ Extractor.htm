<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pin (Point) GeoJSON ãƒãƒ¼ã‚¸ & ä½æ‰€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            margin: 20px;
            background-color: #f0f2f5;
            color: #333;
        }
        h1 {
            color: #d35400; /* ãƒ”ãƒ³ã£ã½ã„è‰²ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸/èµ¤ç³»ï¼‰ */
            text-align: center;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .step {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .step:last-child {
            border-bottom: none;
        }
        h2 {
            font-size: 1.2em;
            color: #e67e22; /* ãƒ”ãƒ³ã£ã½ã„è‰² */
            margin-bottom: 10px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        input[type="file"] {
            display: block;
            width: 100%;
            padding: 10px;
            background: #fafafa;
            border: 2px dashed #ccc;
            border-radius: 4px;
            cursor: pointer;
        }
        input[type="file"]:hover {
            border-color: #e67e22;
            background: #fffdfa;
        }
        button {
            background-color: #e67e22;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: block;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background-color: #d35400;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        textarea {
            width: 100%;
            height: 250px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            background-color: #f9f9f9;
        }
        .message {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            display: none;
            white-space: pre-wrap; /* æ”¹è¡Œã‚’æœ‰åŠ¹ã«ã™ã‚‹ */
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .stats {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        #fileList {
            list-style: none;
            padding: 0;
            margin: 10px 0;
            font-size: 0.9em;
            color: #555;
        }
        #fileList li {
            margin-bottom: 3px;
        }
        #clearFilesBtn { /* æ–°è¦è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
            background-color: #95a5a6;
            margin-top: 5px;
        }
        #clearFilesBtn:hover {
            background-color: #7f8c8d;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Pin (Point) GeoJSON ãƒãƒ¼ã‚¸ & ä½æ‰€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°</h1>
        <p>è¤‡æ•°ã®GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµåˆã—ã€é‡è¤‡ã‚’é™¤å»ã—ãŸå¾Œã€æŒ‡å®šã•ã‚ŒãŸCSVã®ä½æ‰€ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¾ã™ã€‚</p>

        <div class="step">
            <h2>1. GeoJSONãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ (è¿½åŠ å…¥åŠ›å¯)</h2>
            <label for="files">GeoJSONãƒ•ã‚¡ã‚¤ãƒ« (.json, .geojson):</label>
            <p class="stats" style="margin-bottom: 5px;">â€» ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã™ã‚‹ãŸã³ã«ãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚**Ctrl/Shiftã‚­ãƒ¼ã§è¤‡æ•°é¸æŠã‚‚å¯èƒ½**ã§ã™ã€‚</p>
            <input type="file" id="files" accept=".json,.geojson" multiple onchange="addFiles()">
            <ul id="fileList"></ul>
            <button onclick="clearGeoJsonFiles()" id="clearFilesBtn">å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚¯ãƒªã‚¢</button>
        </div>
        
        <div class="step">
            <h2>1.5. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ç”¨CSVé¸æŠ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</h2>
            <label for="csvFile">ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ä½æ‰€ãƒªã‚¹ãƒˆCSV (.csv):</label>
            <p class="stats">
                â€» CSVã¯ãƒ˜ãƒƒãƒ€ãƒ¼ãªã—ã€**1è¡Œç›®ã‹ã‚‰ä½æ‰€ãƒ‡ãƒ¼ã‚¿ï¼ˆ1åˆ—ç›®ï¼‰**ã¨ã—ã¦èª­ã¿è¾¼ã¿ã¾ã™ã€‚<br>
                â€» GeoJSON Featureã®Propertieså†…ã®å€¤ã«ã€ã“ã®ä½æ‰€ãŒ**éƒ¨åˆ†ä¸€è‡´**ã™ã‚‹å ´åˆã«ãƒ”ãƒ³ãŒå‡ºåŠ›ã•ã‚Œã¾ã™ã€‚<br>
                â€» æœªé¸æŠã®å ´åˆã¯å…¨ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒ”ãƒ³ã‚’å‡ºåŠ›ã€‚
            </p>
            <input type="file" id="csvFile" accept=".csv" onchange="updateCsvStatus()">
            <p id="csvStatus" class="stats"></p>
        </div>

        <div class="step">
            <h2>2. å‡¦ç†å®Ÿè¡Œ</h2>
            <p class="stats">â€»ã€Œç·¯åº¦çµŒåº¦ã€ã¨ã€Œå±æ€§(ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£)ã€ã®ä¸¡æ–¹ãŒå®Œå…¨ã«ä¸€è‡´ã™ã‚‹ãƒ”ãƒ³ã‚’åŒä¸€ã¨ã¿ãªã—ã¾ã™ã€‚</p>
            <button onclick="processFiles()" id="processBtn">ãƒãƒ¼ã‚¸ãƒ»é‡è¤‡å‰Šé™¤ & ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å®Ÿè¡Œ</button>
            <div id="statusMessage" class="message"></div>
        </div>

        <div class="step">
            <h2>3. çµæœå‡ºåŠ›</h2>
            <textarea id="outputArea" readonly placeholder="ã“ã“ã«å‡¦ç†çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™..."></textarea>
            <button onclick="downloadResult()" id="downloadBtn" style="display:none; background-color: #28a745; margin-top: 10px;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (filtered_unique_points.geojson)</button>
        </div>
    </div>

    <script>
        let mergedResultString = "";
        let uploadedGeoJsonFiles = []; // é¸æŠã•ã‚ŒãŸå…¨GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°

        // 0. GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ å…¥åŠ›ã™ã‚‹é–¢æ•° (onchangeã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰å‘¼ã³å‡ºã—)
        function addFiles() {
            const input = document.getElementById('files');
            // æ–°ã—ãé¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒªã‚¹ãƒˆã«è¿½åŠ 
            uploadedGeoJsonFiles = uploadedGeoJsonFiles.concat(Array.from(input.files));
            
            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢ï¼ˆåŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†åº¦é¸æŠå¯èƒ½ã«ã™ã‚‹ãŸã‚ï¼‰
            input.value = null; 

            updateFileList();
        }

        // 1. ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆè¡¨ç¤ºã®æ›´æ–°
        function updateFileList() {
            const list = document.getElementById('fileList');
            list.innerHTML = '';
            
            if (uploadedGeoJsonFiles.length > 0) {
                // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã®è¡¨ç¤º
                uploadedGeoJsonFiles.forEach(file => {
                    const li = document.createElement('li');
                    li.textContent = `ğŸ“ ${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                    list.appendChild(li);
                });

                // åˆè¨ˆæ•°ã®è¡¨ç¤º
                const totalLi = document.createElement('li');
                totalLi.innerHTML = `--- <strong>åˆè¨ˆ ${uploadedGeoJsonFiles.length} ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠæ¸ˆã¿</strong> ---`;
                list.appendChild(totalLi);
            } else {
                const li = document.createElement('li');
                li.textContent = `ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚`;
                list.appendChild(li);
            }
        }

        // é¸æŠã•ã‚ŒãŸGeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°
        function clearGeoJsonFiles() {
            uploadedGeoJsonFiles = [];
            updateFileList();
        }

        // CSVãƒ•ã‚¡ã‚¤ãƒ«é¸æŠçŠ¶æ…‹ã®æ›´æ–° (å¤‰æ›´ãªã—)
        function updateCsvStatus() {
            const input = document.getElementById('csvFile');
            const status = document.getElementById('csvStatus');
            
            if (input.files.length > 0) {
                status.textContent = `âœ… CSVãƒ•ã‚¡ã‚¤ãƒ«: ${input.files[0].name} ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚`;
            } else {
                status.textContent = `(CSVãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¯ä½¿ç”¨ã—ã¾ã›ã‚“)`;
            }
        }

        // 2. æ­£è¦åŒ–æ–‡å­—åˆ—å¤‰æ›ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚­ãƒ¼é †åºã«ä¾å­˜ã—ãªã„æ¯”è¼ƒç”¨ï¼‰ (å¤‰æ›´ãªã—)
        function consistentStringify(obj) {
            if (obj === null || typeof obj !== 'object') {
                return JSON.stringify(obj);
            }
            
            if (Array.isArray(obj)) {
                return '[' + obj.map(item => consistentStringify(item)).join(',') + ']';
            }
            
            const sortedKeys = Object.keys(obj).sort();
            const parts = sortedKeys.map(key => {
                return JSON.stringify(key) + ':' + consistentStringify(obj[key]);
            });
            return '{' + parts.join(',') + '}';
        }

        // 3. CSVèª­ã¿è¾¼ã¿ãƒ»ä½æ‰€æŠ½å‡º (å¤‰æ›´ãªã—)
        async function loadCsvAddresses(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const text = e.target.result;
                        const lines = text.trim().split(/\r?\n/);
                        if (lines.length === 0 || (lines.length === 1 && lines[0].trim() === '')) {
                             return resolve([]);
                        }
                        
                        const addresses = [];
                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (line !== '') {
                                const value = line.split(',')[0].trim();
                                
                                if (value !== '') {
                                    addresses.push(value.replace(/[\sã€€]+/g, ''));
                                }
                            }
                        }
                        resolve(addresses.filter((v, i, a) => a.indexOf(v) === i)); 
                    } catch (err) {
                        reject(`CSVãƒ•ã‚¡ã‚¤ãƒ«ã®è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${err.message}`);
                    }
                };
                reader.onerror = () => reject("CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                reader.readAsText(file); 
            });
        }

        // 4. ãƒ¡ã‚¤ãƒ³å‡¦ç†å®Ÿè¡Œ (GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã®å‚ç…§å…ˆã‚’ä¿®æ­£)
        async function processFiles() {
            const csvInput = document.getElementById('csvFile');
            const statusDiv = document.getElementById('statusMessage');
            const outputArea = document.getElementById('outputArea');
            const downloadBtn = document.getElementById('downloadBtn');
            const processBtn = document.getElementById('processBtn');

            // â˜…ä¿®æ­£: ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’å‚ç…§â˜…
            const filesToProcess = uploadedGeoJsonFiles; 

            if (filesToProcess.length === 0) {
                alert("GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            processBtn.disabled = true;
            processBtn.textContent = "å‡¦ç†ä¸­...";
            statusDiv.style.display = 'none';
            outputArea.value = "";
            downloadBtn.style.display = "none";

            try {
                // --- A. GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã¨ãƒãƒ¼ã‚¸/ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ– ---
                let allFeatures = [];

                // GeoJSONèª­ã¿è¾¼ã¿ï¼ˆPromise.allã§ä¸¦åˆ—å®Ÿè¡Œï¼‰
                const filePromises = filesToProcess.map(file => { // â˜…ä¿®æ­£: filesToProcessã‚’å‚ç…§â˜…
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = e => {
                            try {
                                const json = JSON.parse(e.target.result);
                                resolve(json);
                            } catch (err) {
                                reject(`GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã¯æœ‰åŠ¹ãªJSONã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
                            }
                        };
                        reader.onerror = () => reject(`GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
                        reader.readAsText(file);
                    });
                });

                const results = await Promise.all(filePromises);

                // Featureã®åé›†
                results.forEach(data => {
                    if (data.type === "FeatureCollection" && Array.isArray(data.features)) {
                        allFeatures = allFeatures.concat(data.features);
                    } else if (data.type === "Feature") {
                        allFeatures.push(data);
                    }
                });

                const totalInputCount = allFeatures.length;

                // ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–å‡¦ç†
                const uniqueFeatures = [];
                const seenSignatures = new Set();
                allFeatures.forEach(feature => {
                    if (feature.geometry && feature.geometry.type === "Point") {
                        const geomStr = consistentStringify(feature.geometry);
                        const propStr = consistentStringify(feature.properties);
                        const signature = `${geomStr}|${propStr}`;

                        if (!seenSignatures.has(signature)) {
                            seenSignatures.add(signature);
                            uniqueFeatures.push(feature);
                        }
                    }
                });

                const uniqueCount = uniqueFeatures.length;
                const removedCount = totalInputCount - uniqueCount;
                let finalFeatures = uniqueFeatures;
                let filterStats = "";

                // --- B. CSVãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å‡¦ç† (å¤‰æ›´ãªã—) ---
                if (csvInput.files.length > 0) {
                    const csvFile = csvInput.files[0];
                    const filteringAddresses = await loadCsvAddresses(csvFile);

                    if (filteringAddresses.length > 0) {
                        const filteredCountBefore = finalFeatures.length;

                        finalFeatures = finalFeatures.filter(feature => {
                            const properties = feature.properties || {};
                            
                            const allPropsString = Object.values(properties)
                                .map(v => String(v || ''))
                                .join('|')
                                .replace(/[\sã€€]+/g, ''); 

                            return filteringAddresses.some(addr => {
                                return allPropsString.includes(addr);
                            });
                        });

                        const filteredCountAfter = finalFeatures.length;
                        filterStats = ` (CSVãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä»¶æ•°: ${filteringAddresses.length}ä»¶ã€${filteredCountBefore} â†’ æœ€çµ‚ ${filteredCountAfter}ä»¶)`;
                    } else {
                        filterStats = " (CSVã‹ã‚‰æœ‰åŠ¹ãªä½æ‰€ãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸãŸã‚ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ)";
                    }
                }

                // --- C. çµæœå‡ºåŠ› ---
                const resultGeoJSON = {
                    type: "FeatureCollection",
                    features: finalFeatures
                };

                mergedResultString = JSON.stringify(resultGeoJSON, null, 2);
                outputArea.value = mergedResultString;
                
                statusDiv.textContent = `âœ… å‡¦ç†å®Œäº†: ${filesToProcess.length}ãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµåˆã—ã¾ã—ãŸã€‚\n` + // â˜…ä¿®æ­£: filesToProcessã‚’å‚ç…§â˜…
                                        `åˆè¨ˆãƒ”ãƒ³æ•°: ${totalInputCount} â†’ ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–: ${uniqueCount} (é‡è¤‡å‰Šé™¤: ${removedCount})${filterStats}`;
                statusDiv.className = "message success";
                statusDiv.style.display = "block";
                downloadBtn.style.display = "block";
                downloadBtn.textContent = `ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (${resultGeoJSON.features.length}ä»¶)`;

            } catch (error) {
                statusDiv.textContent = "âŒ ã‚¨ãƒ©ãƒ¼: " + error;
                statusDiv.className = "message error";
                statusDiv.style.display = "block";
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = "ãƒãƒ¼ã‚¸ãƒ»é‡è¤‡å‰Šé™¤ & ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å®Ÿè¡Œ";
            }
        }

        // 5. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (å¤‰æ›´ãªã—)
        function downloadResult() {
            if (!mergedResultString) return;

            const blob = new Blob([mergedResultString], { type: "application/geo+json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "filtered_unique_points.geojson";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // æœ€åˆã®ãƒ­ãƒ¼ãƒ‰æ™‚ã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–
        updateFileList(); 
    </script>
</body>
</html>