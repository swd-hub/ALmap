<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoJSON ãƒãƒ¼ã‚¸ & é‡è¤‡å‰Šé™¤ãƒ„ãƒ¼ãƒ«</title>
    <style>
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            margin: 20px;
            background-color: #f0f2f5;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .step {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .step:last-child {
            border-bottom: none;
        }
        h2 {
            font-size: 1.2em;
            color: #007bff;
            margin-bottom: 10px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        input[type="file"] {
            display: block;
            width: 100%;
            padding: 10px;
            background: #fafafa;
            border: 2px dashed #ccc;
            border-radius: 4px;
            cursor: pointer;
        }
        input[type="file"]:hover {
            border-color: #007bff;
            background: #f0f8ff;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: block;
            width: 100%;
            margin-top: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        textarea {
            width: 100%;
            height: 250px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
            background-color: #f9f9f9;
        }
        .message {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            display: none;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .stats {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        #fileList {
            list-style: none;
            padding: 0;
            margin: 10px 0;
            font-size: 0.9em;
            color: #555;
        }
        #fileList li {
            margin-bottom: 3px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>GeoJSON ãƒãƒ¼ã‚¸ & ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–</h1>
        <p>è¤‡æ•°ã®GeoJSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€çµåˆã—ã¦é‡è¤‡ã‚’é™¤å»ã—ã¾ã™ã€‚</p>

        <div class="step">
            <h2>1. ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ (è¤‡æ•°å¯)</h2>
            <label for="files">GeoJSONãƒ•ã‚¡ã‚¤ãƒ« (.json, .geojson):</label>
            <input type="file" id="files" accept=".json,.geojson" multiple onchange="updateFileList()">
            <ul id="fileList"></ul>
        </div>

        <div class="step">
            <h2>2. å‡¦ç†å®Ÿè¡Œ</h2>
            <p class="stats">â€»ã€Œå½¢çŠ¶(åº§æ¨™)ã€ã¨ã€Œå±æ€§(ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£)ã€ãŒå®Œå…¨ã«ä¸€è‡´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’é‡è¤‡ã¨ã¿ãªã—ã¾ã™ã€‚</p>
            <button onclick="processFiles()" id="processBtn">ãƒãƒ¼ã‚¸ã—ã¦é‡è¤‡å‰Šé™¤</button>
            <div id="statusMessage" class="message"></div>
        </div>

        <div class="step">
            <h2>3. çµæœå‡ºåŠ›</h2>
            <textarea id="outputArea" readonly placeholder="ã“ã“ã«å‡¦ç†çµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™..."></textarea>
            <button onclick="downloadResult()" id="downloadBtn" style="display:none; background-color: #28a745; margin-top: 10px;">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ (merged_unique.geojson)</button>
        </div>
    </div>

    <script>
        let mergedResultString = "";

        function updateFileList() {
            const input = document.getElementById('files');
            const list = document.getElementById('fileList');
            list.innerHTML = '';
            
            if (input.files.length > 0) {
                for (let i = 0; i < input.files.length; i++) {
                    const li = document.createElement('li');
                    li.textContent = `ğŸ“„ ${input.files[i].name}`;
                    list.appendChild(li);
                }
            }
        }

        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£é †åºã‚’ã‚½ãƒ¼ãƒˆã—ã¦JSONæ–‡å­—åˆ—åŒ–ã™ã‚‹
        // (JSON.stringifyã ã‘ã ã¨ã‚­ãƒ¼ã®é †åºãŒä¸å®šã§ã€åŒã˜ãƒ‡ãƒ¼ã‚¿ã§ã‚‚åˆ¥ç‰©ã¨åˆ¤å®šã•ã‚Œã‚‹ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ãŸã‚)
        function consistentStringify(obj) {
            if (obj === null || typeof obj !== 'object') {
                return JSON.stringify(obj);
            }
            
            // é…åˆ—ã®å ´åˆ
            if (Array.isArray(obj)) {
                return '[' + obj.map(item => consistentStringify(item)).join(',') + ']';
            }
            
            // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã€ã‚­ãƒ¼ã‚’ã‚½ãƒ¼ãƒˆ
            const sortedKeys = Object.keys(obj).sort();
            const parts = sortedKeys.map(key => {
                return JSON.stringify(key) + ':' + consistentStringify(obj[key]);
            });
            return '{' + parts.join(',') + '}';
        }

        async function processFiles() {
            const input = document.getElementById('files');
            const statusDiv = document.getElementById('statusMessage');
            const outputArea = document.getElementById('outputArea');
            const downloadBtn = document.getElementById('downloadBtn');
            const processBtn = document.getElementById('processBtn');

            if (input.files.length === 0) {
                alert("ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            processBtn.disabled = true;
            processBtn.textContent = "å‡¦ç†ä¸­...";
            statusDiv.style.display = 'none';
            outputArea.value = "";

            try {
                const files = Array.from(input.files);
                let allFeatures = [];

                // å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸¦åˆ—ã§èª­ã¿è¾¼ã‚€
                const filePromises = files.map(file => {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = e => {
                            try {
                                const json = JSON.parse(e.target.result);
                                resolve(json);
                            } catch (err) {
                                reject(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã¯æœ‰åŠ¹ãªJSONã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`);
                            }
                        };
                        reader.onerror = () => reject(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${file.name}ã€ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚`);
                        reader.readAsText(file);
                    });
                });

                const results = await Promise.all(filePromises);

                // èª­ã¿è¾¼ã‚“ã JSONã‹ã‚‰Featureã‚’æŠ½å‡ºã—ã¦çµåˆ
                results.forEach(data => {
                    if (data.type === "FeatureCollection" && Array.isArray(data.features)) {
                        allFeatures = allFeatures.concat(data.features);
                    } else if (data.type === "Feature") {
                        allFeatures.push(data);
                    }
                    // å˜ç‹¬ã®Geometryã®å ´åˆãªã©ã®å¯¾å¿œãŒå¿…è¦ãªã‚‰ã“ã“ã«è¿½åŠ 
                });

                const totalCount = allFeatures.length;
                
                // é‡è¤‡å‰Šé™¤å‡¦ç†
                const uniqueFeatures = [];
                const seenSignatures = new Set();

                allFeatures.forEach(feature => {
                    // ä¸€æ„æ€§ã‚’åˆ¤å®šã™ã‚‹ãŸã‚ã®ç½²åã‚’ä½œæˆ
                    // Geometryã¨Propertiesã®ä¸¡æ–¹ã‚’æ–‡å­—åˆ—åŒ–ã—ã¦ã‚­ãƒ¼ã«ã™ã‚‹
                    const geomStr = consistentStringify(feature.geometry);
                    const propStr = consistentStringify(feature.properties);
                    const signature = `${geomStr}|${propStr}`;

                    if (!seenSignatures.has(signature)) {
                        seenSignatures.add(signature);
                        uniqueFeatures.push(feature);
                    }
                });

                const uniqueCount = uniqueFeatures.length;
                const removedCount = totalCount - uniqueCount;

                // çµæœã®æ§‹ç¯‰
                const resultGeoJSON = {
                    type: "FeatureCollection",
                    features: uniqueFeatures
                };

                mergedResultString = JSON.stringify(resultGeoJSON, null, 2);
                outputArea.value = mergedResultString;
                
                // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                statusDiv.textContent = `å®Œäº†: ${files.length}ãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµåˆã—ã¾ã—ãŸã€‚\n` + 
                                      `åˆè¨ˆãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼æ•°: ${totalCount} â†’ çµæœ: ${uniqueCount} (é‡è¤‡å‰Šé™¤: ${removedCount})`;
                statusDiv.className = "message success";
                statusDiv.style.display = "block";
                downloadBtn.style.display = "block";

            } catch (error) {
                statusDiv.textContent = "ã‚¨ãƒ©ãƒ¼: " + error;
                statusDiv.className = "message error";
                statusDiv.style.display = "block";
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = "ãƒãƒ¼ã‚¸ã—ã¦é‡è¤‡å‰Šé™¤";
            }
        }

        function downloadResult() {
            if (!mergedResultString) return;

            const blob = new Blob([mergedResultString], { type: "application/geo+json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "merged_unique_polygon.geojson";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
